
/*
  * Licensed to the Apache Software Foundation (ASF) under one
  * or more contributor license agreements.  See the NOTICE file
  * distributed with this work for additional information
  * regarding copyright ownership.  The ASF licenses this file
  * to you under the Apache License, Version 2.0 (the
  * "License"); you may not use this file except in compliance
  * with the License.  You may obtain a copy of the License at
  *
  *     http://www.apache.org/licenses/LICENSE-2.0
  *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */

var P=function(e,n,t,o){return new(t||(t=Promise))(function(s,r){function u(i){try{l(o.next(i))}catch(c){r(c)}}function a(i){try{l(o.throw(i))}catch(c){r(c)}}function l(i){i.done?s(i.value):new t(function(c){c(i.value)}).then(u,a)}l((o=o.apply(e,n||[])).next())})},I=function(e,n){var t={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},o,s,r,u;return u={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(u[Symbol.iterator]=function(){return this}),u;function a(i){return function(c){return l([i,c])}}function l(i){if(o)throw new TypeError("Generator is already executing.");for(;t;)try{if(o=1,s&&(r=i[0]&2?s.return:i[0]?s.throw||((r=s.return)&&r.call(s),0):s.next)&&!(r=r.call(s,i[1])).done)return r;switch(s=0,r&&(i=[i[0]&2,r.value]),i[0]){case 0:case 1:r=i;break;case 4:return t.label++,{value:i[1],done:!1};case 5:t.label++,s=i[1],i=[0];continue;case 7:i=t.ops.pop(),t.trys.pop();continue;default:if(r=t.trys,!(r=r.length>0&&r[r.length-1])&&(i[0]===6||i[0]===2)){t=0;continue}if(i[0]===3&&(!r||i[1]>r[0]&&i[1]<r[3])){t.label=i[1];break}if(i[0]===6&&t.label<r[1]){t.label=r[1],r=i;break}if(r&&t.label<r[2]){t.label=r[2],t.ops.push(i);break}r[2]&&t.ops.pop(),t.trys.pop();continue}i=n.call(e,t)}catch(c){i=[6,c],s=0}finally{o=r=0}if(i[0]&5)throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}},O=function(){function e(n,t){var o=this;this._modeId=n,this._defaults=t,this._worker=null,this._idleCheckInterval=setInterval(function(){return o._checkIfIdle()},3e4),this._lastUsedTime=0,this._configChangeListener=this._defaults.onDidChange(function(){return o._stopWorker()}),this._updateExtraLibsToken=0,this._extraLibsChangeListener=this._defaults.onDidExtraLibsChange(function(){return o._updateExtraLibs()})}return e.prototype._stopWorker=function(){this._worker&&(this._worker.dispose(),this._worker=null),this._client=null},e.prototype.dispose=function(){clearInterval(this._idleCheckInterval),this._configChangeListener.dispose(),this._extraLibsChangeListener.dispose(),this._stopWorker()},e.prototype._updateExtraLibs=function(){return P(this,void 0,void 0,function(){var n,t;return I(this,function(o){switch(o.label){case 0:return this._worker?(n=++this._updateExtraLibsToken,[4,this._worker.getProxy()]):[2];case 1:return t=o.sent(),this._updateExtraLibsToken!==n?[2]:(t.updateExtraLibs(this._defaults.getExtraLibs()),[2])}})})},e.prototype._checkIfIdle=function(){if(this._worker){var n=this._defaults.getWorkerMaxIdleTime(),t=Date.now()-this._lastUsedTime;n>0&&t>n&&this._stopWorker()}},e.prototype._getClient=function(){var n=this;if(this._lastUsedTime=Date.now(),!this._client){this._worker=monaco.editor.createWebWorker({moduleId:"vs/language/typescript/tsWorker",label:this._modeId,createData:{compilerOptions:this._defaults.getCompilerOptions(),extraLibs:this._defaults.getExtraLibs()}});var t=this._worker.getProxy();this._defaults.getEagerModelSync()&&(t=t.then(function(o){return n._worker.withSyncedResources(monaco.editor.getModels().filter(function(s){return s.getModeId()===n._modeId}).map(function(s){return s.uri}))})),this._client=t}return this._client},e.prototype.getLanguageServiceWorker=function(){for(var n=this,t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];var s;return this._getClient().then(function(r){s=r}).then(function(r){return n._worker.withSyncedResources(t)}).then(function(r){return s})},e}(),h=function(){var e=function(n,t){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,s){o.__proto__=s}||function(o,s){for(var r in s)s.hasOwnProperty(r)&&(o[r]=s[r])},e(n,t)};return function(n,t){e(n,t);function o(){this.constructor=n}n.prototype=t===null?Object.create(t):(o.prototype=t.prototype,new o)}}(),C=monaco.Uri,T=monaco.Range,k;(function(e){e[e.None=0]="None",e[e.Block=1]="Block",e[e.Smart=2]="Smart"})(k||(k={}));function D(e,n){if(typeof e=="string")return e;for(var t=e,o="",s=0;t;){if(s){o+=n;for(var r=0;r<s;r++)o+="  "}o+=t.messageText,s++,t=t.next}return o}function v(e){return e?e.map(function(n){return n.text}).join(""):""}var b=function(){function e(n){this._worker=n}return e.prototype._positionToOffset=function(n,t){var o=monaco.editor.getModel(n);return o.getOffsetAt(t)},e.prototype._offsetToPosition=function(n,t){var o=monaco.editor.getModel(n);return o.getPositionAt(t)},e.prototype._textSpanToRange=function(n,t){var o=this._offsetToPosition(n,t.start),s=this._offsetToPosition(n,t.start+t.length),r=o.lineNumber,u=o.column,a=s.lineNumber,l=s.column;return{startLineNumber:r,startColumn:u,endLineNumber:a,endColumn:l}},e}(),K=function(e){h(n,e);function n(t,o,s){var r=e.call(this,s)||this;r._defaults=t,r._selector=o,r._disposables=[],r._listener=Object.create(null);var u=function(i){if(i.getModeId()===o){var c,m=i.onDidChangeContent(function(){clearTimeout(c),c=setTimeout(function(){return r._doValidate(i.uri)},500)});r._listener[i.uri.toString()]={dispose:function(){m.dispose(),clearTimeout(c)}},r._doValidate(i.uri)}},a=function(i){monaco.editor.setModelMarkers(i,r._selector,[]);var c=i.uri.toString();r._listener[c]&&(r._listener[c].dispose(),delete r._listener[c])};r._disposables.push(monaco.editor.onDidCreateModel(u)),r._disposables.push(monaco.editor.onWillDisposeModel(a)),r._disposables.push(monaco.editor.onDidChangeModelLanguage(function(i){a(i.model),u(i.model)})),r._disposables.push({dispose:function(){for(var i=0,c=monaco.editor.getModels();i<c.length;i++){var m=c[i];a(m)}}});var l=function(){for(var i=0,c=monaco.editor.getModels();i<c.length;i++){var m=c[i];a(m),u(m)}};return r._disposables.push(r._defaults.onDidChange(l)),r._disposables.push(r._defaults.onDidExtraLibsChange(l)),monaco.editor.getModels().forEach(u),r}return n.prototype.dispose=function(){this._disposables.forEach(function(t){return t&&t.dispose()}),this._disposables=[]},n.prototype._doValidate=function(t){var o=this;this._worker(t).then(function(s){if(!monaco.editor.getModel(t))return null;var r=[],u=o._defaults.getDiagnosticsOptions(),a=u.noSyntaxValidation,l=u.noSemanticValidation;return a||r.push(s.getSyntacticDiagnostics(t.toString())),l||r.push(s.getSemanticDiagnostics(t.toString())),Promise.all(r)}).then(function(s){if(!s||!monaco.editor.getModel(t))return null;var r=s.reduce(function(u,a){return a.concat(u)},[]).map(function(u){return o._convertDiagnostics(t,u)});monaco.editor.setModelMarkers(monaco.editor.getModel(t),o._selector,r)}).then(void 0,function(s){console.error(s)})},n.prototype._convertDiagnostics=function(t,o){var s=this._offsetToPosition(t,o.start),r=s.lineNumber,u=s.column,a=this._offsetToPosition(t,o.start+o.length),l=a.lineNumber,i=a.column;return{severity:monaco.MarkerSeverity.Error,startLineNumber:r,startColumn:u,endLineNumber:l,endColumn:i,message:D(o.messageText,`
`)}},n}(b),L=function(e){h(n,e);function n(){return e!==null&&e.apply(this,arguments)||this}return Object.defineProperty(n.prototype,"triggerCharacters",{get:function(){return["."]},enumerable:!0,configurable:!0}),n.prototype.provideCompletionItems=function(t,o,s,r){var u=t.getWordUntilPosition(o),a=new T(o.lineNumber,u.startColumn,o.lineNumber,u.endColumn),l=t.uri,i=this._positionToOffset(l,o);return this._worker(l).then(function(c){return c.getCompletionsAtPosition(l.toString(),i)}).then(function(c){if(c){var m=c.entries.map(function(g){var d=a;if(g.replacementSpan){var y=t.getPositionAt(g.replacementSpan.start),_=t.getPositionAt(g.replacementSpan.start+g.replacementSpan.length);d=new T(y.lineNumber,y.column,_.lineNumber,_.column)}return{uri:l,position:o,range:d,label:g.name,insertText:g.name,sortText:g.sortText,kind:n.convertKind(g.kind)}});return{suggestions:m}}})},n.prototype.resolveCompletionItem=function(t,o,s,r){var u=this,a=s,l=a.uri,i=a.position;return this._worker(l).then(function(c){return c.getCompletionEntryDetails(l.toString(),u._positionToOffset(l,i),a.label)}).then(function(c){return c?{uri:l,position:i,label:c.name,kind:n.convertKind(c.kind),detail:v(c.displayParts),documentation:{value:v(c.documentation)}}:a})},n.convertKind=function(t){switch(t){case f.primitiveType:case f.keyword:return monaco.languages.CompletionItemKind.Keyword;case f.variable:case f.localVariable:return monaco.languages.CompletionItemKind.Variable;case f.memberVariable:case f.memberGetAccessor:case f.memberSetAccessor:return monaco.languages.CompletionItemKind.Field;case f.function:case f.memberFunction:case f.constructSignature:case f.callSignature:case f.indexSignature:return monaco.languages.CompletionItemKind.Function;case f.enum:return monaco.languages.CompletionItemKind.Enum;case f.module:return monaco.languages.CompletionItemKind.Module;case f.class:return monaco.languages.CompletionItemKind.Class;case f.interface:return monaco.languages.CompletionItemKind.Interface;case f.warning:return monaco.languages.CompletionItemKind.File}return monaco.languages.CompletionItemKind.Property},n}(b),F=function(e){h(n,e);function n(){var t=e!==null&&e.apply(this,arguments)||this;return t.signatureHelpTriggerCharacters=["(",","],t}return n.prototype.provideSignatureHelp=function(t,o,s){var r=this,u=t.uri;return this._worker(u).then(function(a){return a.getSignatureHelpItems(u.toString(),r._positionToOffset(u,o))}).then(function(a){if(a){var l={activeSignature:a.selectedItemIndex,activeParameter:a.argumentIndex,signatures:[]};return a.items.forEach(function(i){var c={label:"",documentation:null,parameters:[]};c.label+=v(i.prefixDisplayParts),i.parameters.forEach(function(m,g,d){var y=v(m.displayParts),_={label:y,documentation:v(m.documentation)};c.label+=y,c.parameters.push(_),g<d.length-1&&(c.label+=v(i.separatorDisplayParts))}),c.label+=v(i.suffixDisplayParts),l.signatures.push(c)}),l}})},n}(b),M=function(e){h(n,e);function n(){return e!==null&&e.apply(this,arguments)||this}return n.prototype.provideHover=function(t,o,s){var r=this,u=t.uri;return this._worker(u).then(function(a){return a.getQuickInfoAtPosition(u.toString(),r._positionToOffset(u,o))}).then(function(a){if(a){var l=v(a.documentation),i=a.tags?a.tags.map(function(m){var g="*@"+m.name+"*";return m.text?g+(m.text.match(/\r\n|\n/g)?` 
`+m.text:" - "+m.text):g}).join(`  

`):"",c=v(a.displayParts);return{range:r._textSpanToRange(u,a.textSpan),contents:[{value:"```js\n"+c+"\n```\n"},{value:l+(i?`

`+i:"")}]}}})},n}(b),N=function(e){h(n,e);function n(){return e!==null&&e.apply(this,arguments)||this}return n.prototype.provideDocumentHighlights=function(t,o,s){var r=this,u=t.uri;return this._worker(u).then(function(a){return a.getOccurrencesAtPosition(u.toString(),r._positionToOffset(u,o))}).then(function(a){if(a)return a.map(function(l){return{range:r._textSpanToRange(u,l.textSpan),kind:l.isWriteAccess?monaco.languages.DocumentHighlightKind.Write:monaco.languages.DocumentHighlightKind.Text}})})},n}(b),E=function(e){h(n,e);function n(){return e!==null&&e.apply(this,arguments)||this}return n.prototype.provideDefinition=function(t,o,s){var r=this,u=t.uri;return this._worker(u).then(function(a){return a.getDefinitionAtPosition(u.toString(),r._positionToOffset(u,o))}).then(function(a){if(a){for(var l=[],i=0,c=a;i<c.length;i++){var m=c[i],g=C.parse(m.fileName);monaco.editor.getModel(g)&&l.push({uri:g,range:r._textSpanToRange(g,m.textSpan)})}return l}})},n}(b),R=function(e){h(n,e);function n(){return e!==null&&e.apply(this,arguments)||this}return n.prototype.provideReferences=function(t,o,s,r){var u=this,a=t.uri;return this._worker(a).then(function(l){return l.getReferencesAtPosition(a.toString(),u._positionToOffset(a,o))}).then(function(l){if(l){for(var i=[],c=0,m=l;c<m.length;c++){var g=m[c],d=C.parse(g.fileName);monaco.editor.getModel(d)&&i.push({uri:d,range:u._textSpanToRange(d,g.textSpan)})}return i}})},n}(b),W=function(e){h(n,e);function n(){return e!==null&&e.apply(this,arguments)||this}return n.prototype.provideDocumentSymbols=function(t,o){var s=this,r=t.uri;return this._worker(r).then(function(u){return u.getNavigationBarItems(r.toString())}).then(function(u){if(u){var a=function(i,c,m){var g={name:c.text,detail:"",kind:p[c.kind]||monaco.languages.SymbolKind.Variable,range:s._textSpanToRange(r,c.spans[0]),selectionRange:s._textSpanToRange(r,c.spans[0]),containerName:m};if(c.childItems&&c.childItems.length>0)for(var d=0,y=c.childItems;d<y.length;d++){var _=y[d];a(i,_,g.name)}i.push(g)},l=[];return u.forEach(function(i){return a(l,i)}),l}})},n}(b),f=function(){function e(){}return e.unknown="",e.keyword="keyword",e.script="script",e.module="module",e.class="class",e.interface="interface",e.type="type",e.enum="enum",e.variable="var",e.localVariable="local var",e.function="function",e.localFunction="local function",e.memberFunction="method",e.memberGetAccessor="getter",e.memberSetAccessor="setter",e.memberVariable="property",e.constructorImplementation="constructor",e.callSignature="call",e.indexSignature="index",e.constructSignature="construct",e.parameter="parameter",e.typeParameter="type parameter",e.primitiveType="primitive type",e.label="label",e.alias="alias",e.const="const",e.let="let",e.warning="warning",e}(),p=Object.create(null);p[f.module]=monaco.languages.SymbolKind.Module;p[f.class]=monaco.languages.SymbolKind.Class;p[f.enum]=monaco.languages.SymbolKind.Enum;p[f.interface]=monaco.languages.SymbolKind.Interface;p[f.memberFunction]=monaco.languages.SymbolKind.Method;p[f.memberVariable]=monaco.languages.SymbolKind.Property;p[f.memberGetAccessor]=monaco.languages.SymbolKind.Property;p[f.memberSetAccessor]=monaco.languages.SymbolKind.Property;p[f.variable]=monaco.languages.SymbolKind.Variable;p[f.const]=monaco.languages.SymbolKind.Variable;p[f.localVariable]=monaco.languages.SymbolKind.Variable;p[f.variable]=monaco.languages.SymbolKind.Variable;p[f.function]=monaco.languages.SymbolKind.Function;p[f.localFunction]=monaco.languages.SymbolKind.Function;var S=function(e){h(n,e);function n(){return e!==null&&e.apply(this,arguments)||this}return n._convertOptions=function(t){return{ConvertTabsToSpaces:t.insertSpaces,TabSize:t.tabSize,IndentSize:t.tabSize,IndentStyle:k.Smart,NewLineCharacter:`
`,InsertSpaceAfterCommaDelimiter:!0,InsertSpaceAfterSemicolonInForStatements:!0,InsertSpaceBeforeAndAfterBinaryOperators:!0,InsertSpaceAfterKeywordsInControlFlowStatements:!0,InsertSpaceAfterFunctionKeywordForAnonymousFunctions:!0,InsertSpaceAfterOpeningAndBeforeClosingNonemptyParenthesis:!1,InsertSpaceAfterOpeningAndBeforeClosingNonemptyBrackets:!1,InsertSpaceAfterOpeningAndBeforeClosingTemplateStringBraces:!1,PlaceOpenBraceOnNewLineForControlBlocks:!1,PlaceOpenBraceOnNewLineForFunctions:!1}},n.prototype._convertTextChanges=function(t,o){return{text:o.newText,range:this._textSpanToRange(t,o.span)}},n}(b),V=function(e){h(n,e);function n(){return e!==null&&e.apply(this,arguments)||this}return n.prototype.provideDocumentRangeFormattingEdits=function(t,o,s,r){var u=this,a=t.uri;return this._worker(a).then(function(l){return l.getFormattingEditsForRange(a.toString(),u._positionToOffset(a,{lineNumber:o.startLineNumber,column:o.startColumn}),u._positionToOffset(a,{lineNumber:o.endLineNumber,column:o.endColumn}),S._convertOptions(s))}).then(function(l){if(l)return l.map(function(i){return u._convertTextChanges(a,i)})})},n}(S),H=function(e){h(n,e);function n(){return e!==null&&e.apply(this,arguments)||this}return Object.defineProperty(n.prototype,"autoFormatTriggerCharacters",{get:function(){return[";","}",`
`]},enumerable:!0,configurable:!0}),n.prototype.provideOnTypeFormattingEdits=function(t,o,s,r,u){var a=this,l=t.uri;return this._worker(l).then(function(i){return i.getFormattingEditsAfterKeystroke(l.toString(),a._positionToOffset(l,o),s,S._convertOptions(r))}).then(function(i){if(i)return i.map(function(c){return a._convertTextChanges(l,c)})})},n}(S),w,x;function B(e){x=A(e,"typescript")}function j(e){w=A(e,"javascript")}function U(){return new Promise(function(e,n){if(!w)return n("JavaScript not registered!");e(w)})}function z(){return new Promise(function(e,n){if(!x)return n("TypeScript not registered!");e(x)})}function A(e,n){var t=new O(n,e),o=function(s){for(var r=[],u=1;u<arguments.length;u++)r[u-1]=arguments[u];return t.getLanguageServiceWorker.apply(t,[s].concat(r))};return monaco.languages.registerCompletionItemProvider(n,new L(o)),monaco.languages.registerSignatureHelpProvider(n,new F(o)),monaco.languages.registerHoverProvider(n,new M(o)),monaco.languages.registerDocumentHighlightProvider(n,new N(o)),monaco.languages.registerDefinitionProvider(n,new E(o)),monaco.languages.registerReferenceProvider(n,new R(o)),monaco.languages.registerDocumentSymbolProvider(n,new W(o)),monaco.languages.registerDocumentRangeFormattingEditProvider(n,new V(o)),monaco.languages.registerOnTypeFormattingEditProvider(n,new H(o)),new K(e,n,o),o}export{U as getJavaScriptWorker,z as getTypeScriptWorker,j as setupJavaScript,B as setupTypeScript};
